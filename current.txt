const fs = require('fs');
const path = require('path');
const util = require('util');

const readFileAsync = util.promisify(fs.readFile);
const writeFileAsync = util.promisify(fs.writeFile);

const inputFilePath = path.join(__dirname, 'data', 'input.txt');
const outputFilePath = path.join(__dirname, 'data', 'output.json');

/**
 * Reads input text file asynchronously
 * @returns {Promise<string>}
 */
async function readInputFile() {
  try {
    const content = await readFileAsync(inputFilePath, 'utf8');
    return content;
  } catch (error) {
    throw new Error(`Error reading input file: ${error.message}`);
  }
}

/**
 * Counts words in a given text, removing punctuation and ignoring case
 * @param {string} text
 * @returns {Object}
 */
function countWords(text) {
  const words = text
    .toLowerCase()
    .match(/\b\w+\b/g); // Matches words only, ignoring punctuation

  if (!words) return {};

  return words.reduce((acc, word) => {
    acc[word] = (acc[word] || 0) + 1;
    return acc;
  }, {});
}

/**
 * Saves the word count result as JSON to output file
 * @param {Object} wordCount
 * @returns {Promise<void>}
 */
async function saveWordCount(wordCount) {
  try {
    await writeFileAsync(outputFilePath, JSON.stringify(wordCount, null, 2), 'utf8');
  } catch (error) {
    throw new Error(`Error writing output file: ${error.message}`);
  }
}

module.exports = {
  readInputFile,
  countWords,
  saveWordCount
};
